name: Update Leaderboard

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-leaderboard:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        pattern: '*-result'
        merge-multiple: true
        
    - name: Prepare results directory
      run: |
        echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ artifacts:"
        ls -R artifacts
        
        mkdir -p leaderboard_results
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Ñ–∞–π–ª—ã
        if [ "$(ls -A artifacts)" ]; then
          echo "–û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤..."
          cd artifacts
          for file in *; do
            username="${file%-result}"
            echo "–û–±—Ä–∞–±–æ—Ç–∫–∞: $file ‚Üí –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: $username"
            mkdir -p "../leaderboard_results/$username"
            mv "$file" "../leaderboard_results/$username/result.json"
          done
        else
          echo "–ê—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
        fi
        
        echo "–§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:"
        find leaderboard_results -type f
        
    - name: Generate leaderboard
      run: |
        # –°–æ–∑–¥–∞–µ–º –∫–∞—Ç–∞–ª–æ–≥ results –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
        mkdir -p results
        
        # –ö–æ–ø–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        if [ -d "leaderboard_results" ]; then
          cp -R leaderboard_results/* results/ || echo "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è"
        fi
        
        python3 leaderboard.py
        cat LEADERBOARD.md
        
    - name: Commit and push
      run: |
        git config user.name "github-actions"
        git config user.email "actions@users.noreply.github.com"
        git add LEADERBOARD.md
        
        if [ -n "$(git status --porcelain)" ]; then
          git commit -m "üìä Automated leaderboard update"
          git push
        else
          echo "No changes to commit"
        fi
